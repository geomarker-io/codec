---
title: "Data"
output:
  html_document:
    toc: true
    toc_depth: 1
    toc_float: true
---

```{css}
#| echo: false
h2 {
  background: #396175;
  color: #ffffff;
  padding: 16px 16px;
  border-radius: 0.5rem;
}

#dl-btn {
  background-color: #c28273;
  color: #ffffff;
  padding: 8px 8px;
  border-radius: 0.25rem;
  display: inline-block;
}
```

```{r}
#| echo: false
#| output: false
#| message: false
devtools::load_all()
codec_tbls <- pins::pin_list(codec_board_local_dev())
```

```{r}
#| echo: false
download_btn <- function(b64, filename, mime = "text/csv") {
  sprintf(
    '<a id="dl-btn" download="%s" href="data:%s;base64,%s">Download csv ⬇️ </a>',
    filename,
    mime,
    b64
  )
}
csv_b64 <- function(x) {
  csv_con <- rawConnection(raw(), open = "wb")
  write.csv(x, csv_con, row.names = FALSE)
  csv_raw <- rawConnectionValue(csv_con)
  close(csv_con)
  csv_b64 <- base64enc::base64encode(csv_raw)
}
```

Community-level data are available as **CoDEC tables** (see `as_codec_tbl()`) included with the [codec](https://github.com/geomarker-io/codec) package for R (see `codec_read()`).

```{r}
#| echo: false
#| results: asis
for (nm in codec_tbls) {
  df <- codec_read(nm, codec_board_local_dev())
  cat(attr(df, "description"), "\n\n")

  cat(glue::glue("## Metadata\n\n"))
  cat("<details>")
  cat(glue::glue("<summary>This CoDEC table has { format(nrow(df), big.mark = ',') } rows and { ncol(df) } columns</summary>"))
  cat("\n\n")
  tibble::tibble(`column name` = names(df),
		 class = sapply(df, class),
		 example = sapply(df, \(x) sample(na.omit(x), 1))) |>
    knitr::kable(format = "pipe") |>
    as.character() |>
    paste(collapse = "\n") |>
    cat("\n\n")
    cat("</details>")
    cat("\n\n\n\n")

  cat(glue::glue("## Download\n\n"))
  cat("\n\n")
  cat(glue::glue("In R:\n\n ```\ncodec::codec_read(\"{ nm }\")\n\n```\n\n\n\n"))
  cat("Manually:\n\n")
  cat(download_btn(csv_b64(df), glue::glue("codec_v{packageVersion('codec')}-{nm}.csv")))
  cat("\n\n")
  cat("\n\n")
  cat("&nbsp;\n\n")
  cat("&nbsp;\n\n")
}
```

