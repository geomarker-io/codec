---
title: "Reading and writing tabular data resources"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading and writing tabular data resources}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(CODECtools)
```

```{r, include = FALSE}
d <-
  tibble::tibble(
    id = c("A01", "A02", "A03"),
    date = as.Date(c("2022-07-25", "2018-07-10", "2013-08-15")),
    measure = c(12.8, 13.9, 15.6),
    rating = factor(c("good", "best", "best"), levels = c("good", "better", "best")),
    ranking = as.integer(c(14, 17, 19)),
    impt = c(FALSE, TRUE, TRUE)
  ) |>
  add_attrs(
    name = "mydata",
    title = "My Data",
    version = "0.1.0",
    homepage = "https://geomarker.io/CODECtools"
  ) |>
  add_col_attrs(id, title = "Identifier", description = "unique identifier") |>
  add_col_attrs(date, title = "Date", description = "date of observation") |>
  add_col_attrs(measure, title = "Measure", description = "measured quantity") |>
  add_col_attrs(rating, title = "Rating", description = "ordered ranking of observation") |>
  add_col_attrs(ranking, title = "Ranking", description = "rank of the observation") |>
  add_col_attrs(impt, title = "Important", description = "true if this observation is important") |>
  add_type_attrs()
```

## Writing a tabular-data-resource to disk

Following our [example](curating-metadata.html), once metadata is set in the tibble's attributes, we can save the tabular data resource as a CSV file with an accompanying tabular-data-resource.yaml:

```{r}
write_tdr_csv(d)
``` 

The `name` attribute of the supplied tibble is used as the name of a newly created folder *and* CSV file containing the data. Metadata extracted from the supplied tibble's attributes is saved in a `tabular-data-resource.yaml` file that lives alongside the data file in the newly created directory:

```{r}
fs::dir_tree("mydata")
```

Additionally, the `profile` is set to `tabular-data-resource` and included in the metadata. This allows for reading, modifying, and writing tabular-data-resources with other software as well.

(To save just the tabular-data-resource.yaml file, use `write_tdr()`.)

## Reading a tabular-data-resource from disk or the web

Since the `tabular-data-resource.yaml` file defines the relative location of the CSV data file in the `path` attribute, specifying this file (or the folder that contains it) is enough to read a tabular-data-resource from disk and restore its attributes and column classes in R:

```{r}
mydata <- read_tdr_csv("mydata")
mydata
glimpse_tdr(mydata)
```

If the `tdr_file` is a URL, then the tabular-data-resource and CSV data files are automatically downloaded first:

```{r}
lndcvr <-
  read_tdr_csv("https://github.com/geomarker-io/hamilton_landcover/releases/download/v0.1.0"
)

glimpse_tdr(lndcvr) |>
  knitr::kable()
```

## Reading and writing just the metadata for a tabular-data-resource

It can be useful to read or download the metadata associated with a tabular-data-resource object. The `read_tdr()` function does this, and returns a list with two items: (1) the tabular-data-resource metadata list and (2) the file path or URL to the data file, generated by expressing the `path` relative to how the location of the `tabular-data-resource.yaml` file was specified.

```{r}
read_tdr("mydata") |>
  str(2)
```

```{r, include = FALSE}
fs::dir_delete("mydata")
```

This would return a different `csv_file` if the tabular-data-resource had been specified using an absolute file path:

```{r eval = FALSE}
read_tdr("~/code/CODECtools/tests/testthat/d") |>
  str(2)
```

This also works with a URL:

```{r}
read_tdr("https://github.com/geomarker-io/hamilton_landcover/releases/download/v0.1.0") |>
  str(4)
```
